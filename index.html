<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>City Shooting Data Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f12;
    --surface: #13161a;
    --surface2: #1a1e24;
    --border: #22272f;
    --border2: #2d3440;
    --accent: #e2ff55;
    --text: #dde3ea;
    --muted: #52606e;
    --muted2: #8494a3;
    --green: #34d17a;
    --red: #f05252;
    --yellow: #f0b429;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; min-height: 100vh; }
  .wrap { max-width: 1100px; margin: 0 auto; padding: 48px 32px 80px; }

  header { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 36px; gap: 24px; flex-wrap: wrap; }
  .title-block h1 { font-family: 'Bebas Neue', sans-serif; font-size: 52px; letter-spacing: 3px; line-height: 1; }
  .title-block h1 em { color: var(--accent); font-style: normal; }
  .title-meta { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-top: 7px; }
  .controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

  .year-select {
    background: var(--surface2); color: var(--text); border: 1px solid var(--border2);
    font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 1px;
    padding: 10px 30px 10px 14px; outline: none; cursor: pointer; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%2352606e'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 12px center;
  }
  .year-select:focus { border-color: var(--accent); }

  .btn {
    font-family: 'DM Mono', monospace; font-size: 11px; font-weight: 500;
    letter-spacing: 1.5px; text-transform: uppercase; padding: 10px 22px;
    border: none; cursor: pointer; transition: background 0.12s, opacity 0.15s; white-space: nowrap;
  }
  .btn-accent { background: var(--accent); color: #000; }
  .btn-accent:hover { background: #d0ec3e; }
  .btn-accent:disabled { opacity: 0.35; cursor: not-allowed; }
  .btn-ghost { background: transparent; color: var(--muted2); border: 1px solid var(--border2); }
  .btn-ghost:hover { border-color: var(--muted); color: var(--text); }
  .btn-ghost:disabled { opacity: 0.3; cursor: not-allowed; }

  .summary { display: flex; gap: 1px; margin-bottom: 28px; background: var(--border); border: 1px solid var(--border); }
  .summary-cell { flex: 1; background: var(--surface); padding: 18px 22px; min-width: 0; }
  .s-label { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 2.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .s-val { font-family: 'Bebas Neue', sans-serif; font-size: 32px; letter-spacing: 1px; line-height: 1; }
  .s-sub { font-size: 11px; color: var(--muted); margin-top: 3px; }

  .table-card { background: var(--surface); border: 1px solid var(--border); }
  .table-top { display: flex; align-items: center; justify-content: space-between; padding: 14px 24px; border-bottom: 1px solid var(--border); }
  .table-label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); }
  .fetch-status { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 1px; }

  table { width: 100%; border-collapse: collapse; }
  thead th {
    padding: 11px 24px; font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 2px;
    text-transform: uppercase; color: var(--muted); text-align: left;
    border-bottom: 1px solid var(--border); white-space: nowrap; cursor: pointer; user-select: none;
  }
  thead th:hover { color: var(--text); }
  thead th.sorted { color: var(--accent); }
  thead th.r { text-align: right; }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(255,255,255,0.02); }
  td { padding: 14px 24px; vertical-align: middle; }

  .city-name { font-weight: 500; color: var(--text); white-space: nowrap; }
  .city-note { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); margin-top: 3px; }
  .num { font-family: 'DM Mono', monospace; font-size: 13px; text-align: right; white-space: nowrap; }
  .chg { font-family: 'DM Mono', monospace; font-size: 12px; text-align: right; white-space: nowrap; }
  .chg-up { color: var(--red); }
  .chg-down { color: var(--green); }
  .chg-flat { color: var(--muted2); }
  .asof { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted2); text-align: right; white-space: nowrap; }

  .sk { display: inline-block; height: 13px; border-radius: 2px; background: linear-gradient(90deg, var(--border) 25%, var(--surface2) 50%, var(--border) 75%); background-size: 300% 100%; animation: shimmer 1.4s infinite; }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  .dot { display: inline-block; width: 7px; height: 7px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }
  .dot-ok { background: var(--green); }
  .dot-loading { background: var(--yellow); animation: blink 1s ease infinite; }
  .dot-error { background: var(--red); }
  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.2; } }

  .type-badge {
    display: inline-block;
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: 2px;
    white-space: nowrap;
  }
  .type-victims { background: rgba(52,209,122,0.12); color: var(--green); }
  .type-incidents { background: rgba(240,180,41,0.12); color: var(--yellow); }
  .type-non-fatal { background: rgba(100,160,255,0.12); color: #6ab0ff; }
  .type-hom\+nfs { background: rgba(220,120,255,0.12); color: #d47fff; }

  .manual-row { background: rgba(226,255,85,0.03); }
  .manual-row:hover { background: rgba(226,255,85,0.06) !important; }
  .divider-row td { padding: 6px 16px; border-bottom: 1px solid var(--border2); }
  .divider-row span { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 1px; }
  .manual-btn {
    font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px;
    text-transform: uppercase; padding: 4px 10px; border: 1px solid var(--border2);
    background: transparent; color: var(--muted2); cursor: pointer; white-space: nowrap;
  }
  .manual-btn:hover { border-color: var(--accent); color: var(--accent); }

  .manual-modal-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    z-index: 1000; align-items: center; justify-content: center;
  }
  .manual-modal-overlay.open { display: flex; }
  .manual-modal {
    background: var(--surface2); border: 1px solid var(--border2);
    border-top: 3px solid var(--accent); padding: 28px 32px; width: 360px; max-width: 90vw;
  }
  .manual-modal h3 {
    font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 2px;
    color: var(--accent); margin-bottom: 20px;
  }
  .manual-field { margin-bottom: 16px; }
  .manual-field label {
    display: block; font-family: 'DM Mono', monospace; font-size: 9px;
    letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px;
  }
  .manual-field input {
    width: 100%; background: var(--bg); border: 1px solid var(--border2);
    color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px;
    padding: 9px 12px; outline: none;
  }
  .manual-field input:focus { border-color: var(--accent); }
  .manual-actions { display: flex; gap: 10px; margin-top: 20px; }
  .manual-save { flex: 1; background: var(--accent); color: #000; border: none; font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; padding: 10px; cursor: pointer; }
  .manual-save:hover { background: #d0ec3e; }
  .manual-cancel { background: transparent; border: 1px solid var(--border2); color: var(--muted2); font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; padding: 10px 16px; cursor: pointer; }
  .manual-cancel:hover { border-color: var(--muted); }

  .err-msg { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--red); }

  .empty-state { text-align: center; padding: 72px 20px; color: var(--muted); }
  .empty-state .big { font-family: 'Bebas Neue', sans-serif; font-size: 56px; color: var(--border2); letter-spacing: 4px; display: block; margin-bottom: 12px; }
  .empty-state p { font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 1.5px; }

  #prog { position: fixed; top: 0; left: 0; height: 2px; width: 0%; background: var(--accent); transition: width 0.25s ease; z-index: 999; }

  footer { margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--border); font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 1px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 8px; line-height: 1.7; }


  @media (max-width: 700px) {
    .wrap { padding: 28px 16px 60px; }
    .title-block h1 { font-size: 38px; }
    .summary { flex-direction: column; }
    td, thead th { padding: 12px 14px; }
  }
</style>
</head>
<body>
<div id="prog"></div>
<div class="wrap">

  <header>
    <div class="title-block">
      <h1>SHOOTING <em>TRACKER</em></h1>
      <div class="title-meta">Live · Major US Cities · Open Data Portals</div>
    </div>
    <div class="controls">
      <select class="year-select" id="yearSel" onchange="onYearChange()">
        <option value="2026">2026 YTD</option>
        <option value="2025">2025</option>
        <option value="2024">2024</option>
        <option value="2023">2023</option>
        <option value="2022">2022</option>
      </select>
      <button class="btn btn-ghost" id="exportBtn" onclick="exportCSV()" disabled>↓ CSV</button>
      <button class="btn btn-ghost" id="jpegBtn" onclick="exportJPEG()" disabled>↓ JPEG</button>
      <button class="btn btn-accent" id="refreshBtn" onclick="fetchAll()">↻ Refresh All</button>
    </div>
  </header>

  <div class="summary">
    <div class="summary-cell">
      <div class="s-label">Cities Loaded</div>
      <div class="s-val" id="s-cities">—</div>
      <div class="s-sub">of <span id="total-cities">0</span> tracked</div>
    </div>
    <div class="summary-cell">
      <div class="s-label">Total YTD</div>
      <div class="s-val" id="s-ytd">—</div>
      <div class="s-sub">shooting victims / incidents</div>
    </div>
    <div class="summary-cell">
      <div class="s-label">Prior Year</div>
      <div class="s-val" id="s-prior">—</div>
      <div class="s-sub">same date range</div>
    </div>
    <div class="summary-cell">
      <div class="s-label">Overall Change</div>
      <div class="s-val" id="s-chg" style="font-size:28px">—</div>
      <div class="s-sub">year over year</div>
    </div>
  </div>

  <div class="table-card">
    <div class="table-top">
      <div class="table-label">Shooting Incidents by City</div>
      <div class="fetch-status" id="fetchStatus">—</div>
    </div>
    <table>
      <thead>
        <tr>
          <th onclick="doSort('name')">City</th>
          <th class="r sorted" onclick="doSort('ytd')">YTD ↓</th>
          <th class="r" onclick="doSort('prior')">Last YTD</th>
          <th class="r" onclick="doSort('chg')">% Change</th>
          <th class="r" onclick="doSort('asof')">As Of</th>
          <th onclick="doSort('type')">Type</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="5" class="empty-state"><span class="big">READY</span><p>CLICK REFRESH ALL TO FETCH LIVE DATA</p></td></tr>
      </tbody>
    </table>
  </div>

  <footer>
    <div id="footerTs">—</div>
  </footer>

  <!-- Manual Entry Modal -->
  <div class="manual-modal-overlay" id="manualModal">
    <div class="manual-modal">
      <h3 id="manualModalTitle">UPDATE CITY</h3>
      <div class="manual-field">
        <label>YTD Count (current year)</label>
        <input type="number" id="manualYtd" placeholder="e.g. 39">
      </div>
      <div class="manual-field">
        <label>Prior Year YTD Count</label>
        <input type="number" id="manualPrior" placeholder="e.g. 54">
      </div>
      <div class="manual-field">
        <label>As Of Date (YYYY-MM-DD)</label>
        <input type="text" id="manualAsof" placeholder="e.g. 2026-02-20">
      </div>
      <div class="manual-actions">
        <button class="manual-save" onclick="saveManual()">Save</button>
        <button class="manual-cancel" onclick="closeManual()">Cancel</button>
      </div>
    </div>
  </div>

    </div>
  </div>


</div>
<script>
// ─── HELPERS ──────────────────────────────────────────────────────────────────

async function socrataCount(url, where) {
  const q = url + '?$where=' + encodeURIComponent(where) + '&$select=count(*)%20as%20n&$limit=1';
  const r = await fetch(q, { signal: AbortSignal.timeout(15000) });
  if (!r.ok) throw new Error('HTTP ' + r.status);
  const d = await r.json();
  return parseInt(d[0] && d[0].n ? d[0].n : 0);
}

async function socrataLatest(url, dateField, extraWhere) {
  var w = extraWhere ? '&$where=' + encodeURIComponent(extraWhere) : '';
  var q = url + '?$order=' + dateField + '%20DESC&$limit=1&$select=' + dateField + w;
  const r = await fetch(q, { signal: AbortSignal.timeout(10000) });
  if (!r.ok) return null;
  const d = await r.json();
  var v = d[0] && d[0][dateField] ? d[0][dateField] : null;
  return v ? v.slice(0, 10) : null;
}



function todayStr() {
  var n = new Date();
  var mm = String(n.getMonth() + 1).padStart(2, "0");
  var dd = String(n.getDate()).padStart(2, "0");
  return n.getFullYear() + "-" + mm + "-" + dd;
}

var CURRENT_YEAR = new Date().getFullYear();

  // ─── AUTO-FETCHED DATA (from GitHub Action) ───────────────────────────────
  var _autoData = null;
  async function loadAutoData() {
    if (_autoData) return _autoData;
    try {
      var r = await fetch('data/manual-auto.json', { signal: AbortSignal.timeout(5000) });
      if (r.ok) _autoData = await r.json();
    } catch(e) { _autoData = {}; }
    return _autoData || {};
  }

  // ─── PROXY SERVER URL ────────────────────────────────────────────────────────
  // Set this to your proxy server address to enable auto-fetching for Durham
  // e.g. 'http://localhost:3000' or 'https://your-server.com'
  // Leave empty to use stored/hardcoded ADID fallback
  window.PROXY_URL = '';

function getWindows(year) {
  year = parseInt(year, 10);
  var isCurrent = (year === CURRENT_YEAR);
  var start = year + "-01-01";
  var end   = isCurrent ? todayStr() : year + "-12-31";
  var priorStart = (year - 1) + "-01-01";
  var priorEnd   = (year - 1) + end.slice(4);
  return { start: start, end: end, priorStart: priorStart, priorEnd: priorEnd };
}

// ─── CITY CONFIGS ─────────────────────────────────────────────────────────────

var CITIES = [
  {
    id: 'chicago',
    type: 'Victims',
    name: 'Chicago, IL',
    note: 'Shooting Victims (GUNSHOT_INJURY_I=YES)',
    _url: 'https://data.cityofchicago.org/resource/gumc-mgzr.json',
    count: async function(s, e) {
      var where = "date >= '" + s + "T00:00:00.000' AND date <= '" + e + "T23:59:59.000' AND gunshot_injury_i = 'YES'";
      var q = this._url + '?$where=' + encodeURIComponent(where) + '&$select=count(*)%20as%20n&$limit=1';
      var r = await fetch(q, { signal: AbortSignal.timeout(15000) });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      var d = await r.json();
      return parseInt(d[0] && d[0].n ? d[0].n : 0);
    },
    latest: async function() {
      var q = this._url + '?$order=date%20DESC&$limit=1&$select=date&$where=' + encodeURIComponent("gunshot_injury_i = 'YES'");
      try {
        var r = await fetch(q, { signal: AbortSignal.timeout(10000) });
        if (!r.ok) return null;
        var d = await r.json();
        return d[0] && d[0].date ? d[0].date.slice(0, 10) : null;
      } catch(e) { return null; }
    }
  },
  {
    id: 'nyc',
    type: 'Victims',
    name: 'New York City, NY',
    note: 'Shooting Victims (NYPD CompStat PDF)',
    _pdfUrl: 'https://www.nyc.gov/assets/nypd/downloads/pdf/crime_statistics/cs-en-us-city.pdf',
    _parsed: null,
    _parse: async function() {
      if (this._parsed) return this._parsed;
      if (!window.pdfjsLib) {
        await new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
          s.onload = resolve; s.onerror = reject;
          document.head.appendChild(s);
        });
        window.pdfjsLib.GlobalWorkerOptions.workerSrc =
          'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }
      var resp = await fetch(this._pdfUrl, { signal: AbortSignal.timeout(20000) });
      if (!resp.ok) throw new Error('PDF fetch HTTP ' + resp.status);
      var buf = await resp.arrayBuffer();
      var pdf = await window.pdfjsLib.getDocument({ data: buf }).promise;
      var page = await pdf.getPage(1);
      var tc = await page.getTextContent();
      var tokens = tc.items.map(function(i) { return i.str.trim(); }).filter(function(s) { return s.length > 0; });
      var text = tokens.join(' ');
      var dateMatch = text.match(/(\d{1,2}\/\d{1,2}\/\d{4})\s+Through\s+(\d{1,2}\/\d{1,2}\/\d{4})/i);
      if (!dateMatch) throw new Error('Could not find date range in PDF. Tokens: ' + tokens.slice(0,30).join('|'));
      var asofRaw = dateMatch[2];
      var aparts = asofRaw.split('/');
      var asof = aparts[2] + '-' + aparts[0].padStart(2,'0') + '-' + aparts[1].padStart(2,'0');
      var idx = tokens.findIndex(function(t) { return t.match(/shooting\s*vic/i); });
      if (idx === -1) throw new Error('Could not find Shooting Vic row. Tokens: ' + tokens.slice(0,50).join('|'));
      var nums = [];
      for (var i = idx + 1; i < tokens.length && nums.length < 12; i++) {
        if (tokens[i].match(/^-?[\d,]+\.?\d*$/)) nums.push(parseInt(tokens[i].replace(/,/g, '')));
      }
      if (nums.length < 9) throw new Error('Not enough numbers after Shooting Vic. Found: ' + nums.join(','));
      var ytd   = nums[6];
      var prior = nums[7];
      this._parsed = { ytd: ytd, prior: prior, asof: asof };
      return this._parsed;
    },
    count: async function(s, e) {
      var p = await this._parse();
      var windowYear = parseInt(s.slice(0, 4));
      var asofYear   = parseInt(p.asof.slice(0, 4));
      return windowYear === asofYear ? p.ytd : p.prior;
    },
    latest: async function() {
      var p = await this._parse();
      return p.asof;
    }
  },
  {
    id: 'philly',
    type: 'Victims',
    name: 'Philadelphia, PA',
    note: 'Shooting Victims (Carto SQL)',
    count: async function(s, e) {
      var sql = "SELECT COUNT(*) AS n FROM shootings WHERE date_ >= '" + s + "' AND date_ <= '" + e + "'";
      var url = 'https://phl.carto.com/api/v2/sql?format=json&q=' + encodeURIComponent(sql);
      var r = await fetch(url, { signal: AbortSignal.timeout(15000) });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      var d = await r.json();
      return parseInt(d.rows[0].n);
    },
    latest: async function() {
      var sql = "SELECT date_ FROM shootings ORDER BY date_ DESC LIMIT 1";
      var url = 'https://phl.carto.com/api/v2/sql?format=json&q=' + encodeURIComponent(sql);
      try {
        var r = await fetch(url, { signal: AbortSignal.timeout(10000) });
        if (!r.ok) return null;
        var d = await r.json();
        var v = d.rows && d.rows[0] ? d.rows[0].date_ : null;
        return v ? v.slice(0, 10) : null;
      } catch(e) { return null; }
    }
  },
  {
    id: 'baltimore',
    type: 'Victims',
    name: 'Baltimore, MD',
    note: 'Shooting Incidents (NIBRS, Shooting=Y)',
    _url: 'https://services1.arcgis.com/UWYHeuuJISiGmgXx/arcgis/rest/services/NIBRS_GroupA_Crime_Data/FeatureServer/0/query',
    count: async function(s, e) {
      var where = "Shooting = 'Y' AND CrimeDateTime >= DATE '" + s + "' AND CrimeDateTime <= DATE '" + e + "'";
      var url = this._url + '?where=' + encodeURIComponent(where) + '&returnCountOnly=true&f=json';
      var r = await fetch(url, { signal: AbortSignal.timeout(15000) });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      var d = await r.json();
      if (d.error) throw new Error(d.error.message || JSON.stringify(d.error).slice(0, 120));
      return d.count;
    },
    latest: async function() {
      var where = "Shooting = 'Y'";
      var url = this._url + '?where=' + encodeURIComponent(where) +
        '&outFields=CrimeDateTime&orderByFields=CrimeDateTime+DESC&resultRecordCount=1&f=json';
      try {
        var r = await fetch(url, { signal: AbortSignal.timeout(10000) });
        if (!r.ok) return null;
        var d = await r.json();
        if (d.error || !d.features || !d.features.length) return null;
        var raw = d.features[0].attributes.CrimeDateTime;
        if (typeof raw === 'number') {
          var dt = new Date(raw);
          var mm = String(dt.getMonth() + 1).padStart(2, '0');
          var dd = String(dt.getDate()).padStart(2, '0');
          return dt.getFullYear() + '-' + mm + '-' + dd;
        }
        return raw ? raw.slice(0, 10) : null;
      } catch(e) { return null; }
    }
  },
  {
    id: 'nashville',
    name: 'Nashville, TN',
    note: 'Gunshot Injuries (Manual)',
    type: 'Victims',
    manual: true,
    dataUrl: 'https://www.nashville.gov/departments/police/data-dashboard/gunshot-injuries-map',
    count: async function(s, e) {
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  },
  {
    id: 'boston',
    type: 'Victims',
    name: 'Boston, MA',
    note: 'Shooting Incidents (CSV)',
    _csvUrl: 'https://data.boston.gov/datastore/dump/73c7e069-701f-4910-986d-b950f46c91a1?bom=True',
    _cache: null,
    _load: async function() {
      if (this._cache) return this._cache;
      var r = await fetch(this._csvUrl, { signal: AbortSignal.timeout(20000) });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      var text = await r.text();
      var lines = text.trim().split('\n');
      var headers = lines[0].split(',').map(function(h) { return h.trim().replace(/^"|"$/g, ''); });
      var dateIdx = headers.findIndex(function(h) { return h.toUpperCase() === 'SHOOTING_DATE'; });
      if (dateIdx === -1) throw new Error('SHOOTING_DATE column not found. Headers: ' + headers.join(', '));
      var dates = [];
      for (var i = 1; i < lines.length; i++) {
        var cols = lines[i].split(',');
        var val = cols[dateIdx] ? cols[dateIdx].trim().replace(/^"|"$/g, '') : '';
        if (val) dates.push(val.slice(0, 10));
      }
      this._cache = dates;
      return dates;
    },
    count: async function(s, e) {
      var dates = await this._load();
      return dates.filter(function(d) { return d >= s && d <= e; }).length;
    },
    latest: async function() {
      try {
        var dates = await this._load();
        if (!dates.length) return null;
        return dates.slice().sort().pop();
      } catch(e) { return null; }
    }
  },

  {
    id: 'louisville',
    type: 'Victims',
    name: 'Louisville, KY',
    note: 'Gun Violence Victims (Non-Fatal + Homicide)',
    _url: 'https://services1.arcgis.com/79kfd2K6fskCAkyg/arcgis/rest/services/Gun_Violence_Data/FeatureServer/0/query',
    count: async function(s, e) {
      var where = "(Crime_Type = 'Non-Fatal Shooting' OR Crime_Type = 'Homicide')" +
        " AND DateTime >= '" + s + " 00:00:00' AND DateTime <= '" + e + " 23:59:59'";
      var url = this._url + '?where=' + encodeURIComponent(where) + '&returnCountOnly=true&f=json';
      var r = await fetch(url, { signal: AbortSignal.timeout(15000) });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      var d = await r.json();
      if (d.error) throw new Error(d.error.message || JSON.stringify(d.error).slice(0, 120));
      return d.count;
    },
    latest: async function() {
      var where = "Crime_Type = 'Non-Fatal Shooting' OR Crime_Type = 'Homicide'";
      var url = this._url + '?where=' + encodeURIComponent(where) +
        '&outFields=DateTime&orderByFields=DateTime+DESC&resultRecordCount=1&f=json';
      try {
        var r = await fetch(url, { signal: AbortSignal.timeout(10000) });
        if (!r.ok) return null;
        var d = await r.json();
        if (d.error || !d.features || !d.features.length) return null;
        var raw = d.features[0].attributes.DateTime;
        if (typeof raw === 'number') {
          var dt = new Date(raw);
          var mm = String(dt.getMonth() + 1).padStart(2, '0');
          var dd = String(dt.getDate()).padStart(2, '0');
          return dt.getFullYear() + '-' + mm + '-' + dd;
        }
        return raw ? raw.slice(0, 10) : null;
      } catch(e) { return null; }
    }
  },
  {
    id: 'seattle',
    name: 'Seattle, WA',
    note: 'Shooting Victims (Manual)',
    type: 'Victims',
    manual: true,
    dataUrl: 'https://www.seattle.gov/police/information-and-data/data/crime-dashboard',
    count: async function(s, e) {
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  },









{
    id: 'cincinnati',
    type: 'Victims',
    name: 'Cincinnati, OH',
    note: 'Shooting Victims (Socrata)',
    _url: 'https://data.cincinnati-oh.gov/resource/sfea-4ksu.json',
    _fmt: function(d) { return d.replace(/-/g, ''); }, // YYYY-MM-DD -> YYYYMMDD
    count: async function(s, e) {
      return socrataCount(this._url,
        "`dateoccurred` >= '" + this._fmt(s) + "' AND `dateoccurred` <= '" + this._fmt(e) + "'");
    },
    latest: async function() {
      var q = this._url + '?$order=dateoccurred%20DESC&$limit=1&$select=dateoccurred';
      try {
        var r = await fetch(q, { signal: AbortSignal.timeout(10000) });
        if (!r.ok) return null;
        var d = await r.json();
        var raw = d[0] && d[0].dateoccurred ? d[0].dateoccurred : null;
        if (!raw) return null;
        // Handle both YYYYMMDD and already-formatted dates
        if (raw.length === 8) return raw.slice(0,4) + '-' + raw.slice(4,6) + '-' + raw.slice(6,8);
        return raw.slice(0, 10);
      } catch(e) { return null; }
    }
  },
  {
    id: 'stlouis',
    name: 'St. Louis, MO',
    note: 'Shooting Victims (CompStat PDF)',
    type: 'Victims',
    _pdfUrl: 'https://slmpd.org/wp-content/uploads/httpdocs/CompStat/Compstat01A.PDF',
    _parsed: null,
    _parse: async function() {
      if (this._parsed) return this._parsed;
      if (!window.pdfjsLib) {
        await new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
          s.onload = resolve; s.onerror = reject;
          document.head.appendChild(s);
        });
        window.pdfjsLib.GlobalWorkerOptions.workerSrc =
          'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }
      var resp = await fetch(this._pdfUrl, { signal: AbortSignal.timeout(20000) });
      if (!resp.ok) throw new Error('PDF fetch HTTP ' + resp.status);
      var buf = await resp.arrayBuffer();
      var pdf = await window.pdfjsLib.getDocument({ data: buf }).promise;
      var page = await pdf.getPage(1);
      var tc = await page.getTextContent();
      var tokens = tc.items.map(function(i) { return i.str.trim(); }).filter(function(s) { return s.length > 0; });
      var text = tokens.join(' ');

      // Date: "2/2/2026 12:00:00 AM to 2/8/2026" — take last M/D/YYYY before next word
      var dateMatch = text.match(/to\s+(\d{1,2}\/\d{1,2}\/\d{4})/i);
      if (!dateMatch) throw new Error('Could not find end date. Tokens: ' + tokens.slice(0,40).join('|'));
      var aparts = dateMatch[1].split('/');
      var asof = aparts[2] + '-' + aparts[0].padStart(2,'0') + '-' + aparts[1].padStart(2,'0');

      // Find SHOOTING VICTIMS row
      var idx = tokens.findIndex(function(t) { return t.match(/^SHOOTING\s+VICTIMS$/i); });
      if (idx === -1) {
        // Try split across two tokens
        idx = tokens.findIndex(function(t, i) {
          return t.match(/^SHOOTING$/i) && tokens[i+1] && tokens[i+1].match(/^VICTIMS$/i);
        });
        if (idx !== -1) idx = idx; // label spans two tokens, nums start after idx+1
      }
      if (idx === -1) throw new Error('Could not find SHOOTING VICTIMS row. Tokens: ' + tokens.slice(0,60).join('|'));

      // Grab next 12 numeric tokens: [7d26, 7d25, 7dchg, 28d26, 28d25, 28dchg, ytd26, ytd25, ytdchg, ...]
      var nums = [];
      for (var i = idx + 1; i < tokens.length && nums.length < 12; i++) {
        if (tokens[i].match(/^-?[\d,]+\.?\d*$/) && !tokens[i].match(/^-?\d+%$/)) {
          nums.push(parseInt(tokens[i].replace(/,/g, '')));
        }
      }
      if (nums.length < 9) throw new Error('Not enough numbers after SHOOTING VICTIMS. Found: ' + nums.join(','));

      this._parsed = { ytd: nums[4], prior: nums[5], asof: asof };
      return this._parsed;
    },
    count: async function(s, e) {
      var p = await this._parse();
      var windowYear = parseInt(s.slice(0, 4));
      var asofYear   = parseInt(p.asof.slice(0, 4));
      return windowYear === asofYear ? p.ytd : p.prior;
    },
    latest: async function() {
      var p = await this._parse();
      return p.asof;
    }
  },
  {
    id: 'detroit',
    name: 'Detroit, MI',
    note: 'Non-Fatal Shootings',
    type: 'Non-Fatal',
    dataUrl: 'https://detroitmi.gov/Calendar-and-Events?field_start_value=2026-02-19&title=&term_node_tid_depth=All&term_node_tid_depth_1=1676&term_node_tid_depth_2=All',
    count: async function(s, e) {
      // Try auto-fetched data first
      var auto = await loadAutoData();
      if (auto.detroit && auto.detroit.ok) {
        var windowYear = parseInt(s.slice(0,4));
        var asofYear = auto.detroit.asof ? parseInt(auto.detroit.asof.slice(0,4)) : CURRENT_YEAR;
        return windowYear === asofYear ? auto.detroit.ytd : auto.detroit.prior;
      }
      // Fall back to manual storage
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      var auto = await loadAutoData();
      if (auto.detroit && auto.detroit.ok && auto.detroit.asof) return auto.detroit.asof;
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  },
  {
    id: 'durham',
    name: 'Durham, NC',
    note: 'Shooting Victims (Fatal + Non-Fatal, Manual)',
    type: 'Victims',
    dataUrl: 'https://www.durhamnc.gov/Archive.aspx?AMID=211',
    count: async function(s, e) {
      var auto = await loadAutoData();
      if (auto.durham && auto.durham.ok) {
        var windowYear = parseInt(s.slice(0,4));
        var asofYear = auto.durham.asof ? parseInt(auto.durham.asof.slice(0,4)) : CURRENT_YEAR;
        return windowYear === asofYear ? auto.durham.ytd : auto.durham.prior;
      }
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      var auto = await loadAutoData();
      if (auto.durham && auto.durham.ok && auto.durham.asof) return auto.durham.asof;
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  },
  {
    id: 'neworleans',
    name: 'New Orleans, LA',
    note: 'Shooting Incidents (CFS, 30S/34S RTF)',
    type: 'Incidents',
    _datasets: {
      '2026': 'https://data.nola.gov/resource/es9j-6y5d.json',
      '2025': 'https://data.nola.gov/resource/4xwx-sfte.json'
    },
    _getUrl: function(year) {
      return this._datasets[String(year)] || this._datasets['2025'];
    },
    count: async function(s, e) {
      var year = s.slice(0, 4);
      var base = this._getUrl(year);
      var where = "(type_ = '30S' OR type_ = '34S') AND disposition = 'RTF'" +
        " AND timecreate >= '" + s + "T00:00:00.000' AND timecreate <= '" + e + "T23:59:59.000'";
      var url = base + '?$where=' + encodeURIComponent(where) + '&$select=count(*)+as+n&$limit=1';
      var r = await fetch(url, { signal: AbortSignal.timeout(15000) });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      var d = await r.json();
      if (d.error) throw new Error(d.error.message || JSON.stringify(d.error).slice(0, 120));
      return parseInt(d[0].n);
    },
    latest: async function() {
      var year = new Date().getFullYear();
      var base = this._getUrl(year);
      var where = "type_ = '30S' OR type_ = '34S'";
      var url = base + '?$where=' + encodeURIComponent(where) +
        '&$order=timecreate+DESC&$limit=1&$select=timecreate';
      try {
        var r = await fetch(url, { signal: AbortSignal.timeout(10000) });
        if (!r.ok) return null;
        var d = await r.json();
        if (!d.length) return null;
        return d[0].timecreate ? d[0].timecreate.slice(0, 10) : null;
      } catch(e) { return null; }
    }
  },
  {
    id: 'rochester',
    name: 'Rochester, NY',
    note: 'Shooting Victims (ArcGIS)',
    type: 'Victims',
    _url: 'https://services7.arcgis.com/wMvCpnbQEKXZsPSQ/arcgis/rest/services/Rochester_NY_Shooting_Victims/FeatureServer/0/query',
    count: async function(s, e) {
      var where = "Occurred_Date >= '" + s + " 00:00:00' AND Occurred_Date <= '" + e + " 23:59:59'";
      var url = this._url + '?where=' + encodeURIComponent(where) + '&returnCountOnly=true&f=json';
      var r = await fetch(url, { signal: AbortSignal.timeout(15000) });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      var d = await r.json();
      if (d.error) throw new Error(d.error.message || JSON.stringify(d.error).slice(0, 120));
      return d.count;
    },
    latest: async function() {
      var url = this._url + '?where=1%3D1&outFields=Occurred_Date&orderByFields=Occurred_Date+DESC&resultRecordCount=1&f=json';
      try {
        var r = await fetch(url, { signal: AbortSignal.timeout(10000) });
        if (!r.ok) return null;
        var d = await r.json();
        if (d.error || !d.features || !d.features.length) return null;
        var raw = d.features[0].attributes.Occurred_Date;
        if (typeof raw === 'number') {
          var dt = new Date(raw);
          var mm = String(dt.getMonth() + 1).padStart(2, '0');
          var dd = String(dt.getDate()).padStart(2, '0');
          return dt.getFullYear() + '-' + mm + '-' + dd;
        }
        return raw ? raw.slice(0, 10) : null;
      } catch(e) { return null; }
    }
  },
  {
    id: 'portland',
    name: 'Portland, OR',
    note: 'Shooting Victims (Manual)',
    type: 'Victims',
    manual: true,
    dataUrl: 'https://public.tableau.com/app/profile/portlandpolicebureau/viz/PortlandShootingIncidentStatistics/ShootingIncidentStatistics',
    count: async function(s, e) {
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  },
  {
    id: 'pittsburgh',
    name: 'Pittsburgh, PA',
    note: 'Shooting Victims (Homicide + Non-Fatal, Gun)',
    type: 'Victims',
    dataUrl: 'https://app.powerbigov.us/view?r=eyJrIjoiMDYzNWMyNGItNWNjMS00ODMwLWIxZDgtMTNkNzhlZDE2OWFjIiwidCI6ImY1ZjQ3OTE3LWM5MDQtNDM2OC05MTIwLWQzMjdjZjE3NTU5MSJ9',
    count: async function(s, e) {
      var auto = await loadAutoData();
      if (auto.pittsburgh && auto.pittsburgh.ok) {
        var windowYear = parseInt(s.slice(0,4));
        var asofYear = auto.pittsburgh.asof ? parseInt(auto.pittsburgh.asof.slice(0,4)) : CURRENT_YEAR;
        return windowYear === asofYear ? auto.pittsburgh.ytd : auto.pittsburgh.prior;
      }
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      var auto = await loadAutoData();
      if (auto.pittsburgh && auto.pittsburgh.ok && auto.pittsburgh.asof) return auto.pittsburgh.asof;
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  },


  {
    id: 'minneapolis',
    name: 'Minneapolis, MN',
    note: 'Gunshot Wound Victims (sum of Crime_Count)',
    type: 'Non-Fatal',
    _url: 'https://services.arcgis.com/afSMGVsC7QlRK1kZ/arcgis/rest/services/Crime_Data/FeatureServer/0/query',
    count: async function(s, e) {
      var where = "Type = 'Gunshot Wound Victims'" +
        " AND Reported_Date >= TIMESTAMP '" + s + " 00:00:00' AND Reported_Date <= TIMESTAMP '" + e + " 23:59:59'";
      var url = this._url + '?where=' + encodeURIComponent(where) +
        '&outStatistics=' + encodeURIComponent('[{"statisticType":"sum","onStatisticField":"Crime_Count","outStatisticFieldName":"total"}]') +
        '&f=json';
      var r = await fetch(url, { signal: AbortSignal.timeout(15000) });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      var d = await r.json();
      if (d.error) throw new Error(d.error.message || JSON.stringify(d.error).slice(0, 120));
      return d.features[0].attributes.total;
    },
    latest: async function() {
      var where = "Type = 'Gunshot Wound Victims'";
      var url = this._url + '?where=' + encodeURIComponent(where) +
        '&outFields=Reported_Date&orderByFields=Reported_Date+DESC&resultRecordCount=1&f=json';
      try {
        var r = await fetch(url, { signal: AbortSignal.timeout(10000) });
        if (!r.ok) return null;
        var d = await r.json();
        if (d.error || !d.features || !d.features.length) return null;
        var raw = d.features[0].attributes.Reported_Date;
        if (!raw) return null;
        if (typeof raw === 'number') {
          var dt = new Date(raw);
          var mm = String(dt.getMonth() + 1).padStart(2, '0');
          var dd = String(dt.getDate()).padStart(2, '0');
          return dt.getFullYear() + '-' + mm + '-' + dd;
        }
        // Format: "2026/02/17 18:28:00+00" → "2026-02-17"
        return String(raw).slice(0, 10).replace(/\//g, '-');
      } catch(e) { return null; }
    }
  },
  {
    id: 'memphis',
    name: 'Memphis, TN',
    note: 'Non-Fatal Shooting Incidents (Power BI)',
    type: 'Non-Fatal',
    dataUrl: 'https://app.powerbigov.us/view?r=eyJrIjoiZTYyYmQ0Y2QtZTM0Ni00ZTFiLThkMjMtOTYxYWZiOWUyZDU4IiwidCI6IjQxNjQ3NTYxLTY1MzctNDQyMy05NmE5LTg1OWU4OWY4OTE5ZiJ9',
    count: async function(s, e) {
      var auto = await loadAutoData();
      if (auto.memphis && auto.memphis.ok) {
        var windowYear = parseInt(s.slice(0,4));
        var asofYear = auto.memphis.asof ? parseInt(auto.memphis.asof.slice(0,4)) : CURRENT_YEAR;
        return windowYear === asofYear ? auto.memphis.ytd : auto.memphis.prior;
      }
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      var auto = await loadAutoData();
      if (auto.memphis && auto.memphis.ok && auto.memphis.asof) return auto.memphis.asof;
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  },
  {
    id: 'milwaukee',
    name: 'Milwaukee, WI',
    note: 'Non-Fatal Shootings (Tableau)',
    type: 'Non-Fatal',
    count: async function(s, e) {
      var auto = await loadAutoData();
      if (auto.milwaukee && auto.milwaukee.ok) {
        var windowYear = parseInt(s.slice(0,4));
        var asofYear = auto.milwaukee.asof ? parseInt(auto.milwaukee.asof.slice(0,4)) : CURRENT_YEAR;
        return windowYear === asofYear ? auto.milwaukee.ytd : auto.milwaukee.prior;
      }
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      var auto = await loadAutoData();
      if (auto.milwaukee && auto.milwaukee.ok && auto.milwaukee.asof) return auto.milwaukee.asof;
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  },
  {
    id: 'lasvegas',
    name: 'Las Vegas, NV',
    note: 'Shooting Victims (NIBRS, ShootingVictims=Y)',
    type: 'Victims',
    _url: 'https://services.arcgis.com/jjSk6t82vIntwDbs/arcgis/rest/services/LVMPD_Weekly_NIBRS_Crimes/FeatureServer/0/query',
    count: async function(s, e) {
      var where = "ShootingVictims = 'Y' AND ReportedOn >= '" + s + " 00:00:00' AND ReportedOn <= '" + e + " 23:59:59'";
      var url = this._url + '?where=' + encodeURIComponent(where) + '&returnCountOnly=true&f=json';
      var r = await fetch(url, { signal: AbortSignal.timeout(15000) });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      var d = await r.json();
      if (d.error) throw new Error(d.error.message || JSON.stringify(d.error).slice(0, 120));
      return d.count;
    },
    latest: async function() {
      var where = "ShootingVictims = 'Y'";
      var url = this._url + '?where=' + encodeURIComponent(where) +
        '&outFields=ReportedOn&orderByFields=ReportedOn+DESC&resultRecordCount=1&f=json';
      try {
        var r = await fetch(url, { signal: AbortSignal.timeout(10000) });
        if (!r.ok) return null;
        var d = await r.json();
        if (d.error || !d.features || !d.features.length) return null;
        var raw = d.features[0].attributes.ReportedOn;
        if (typeof raw === 'number') {
          var dt = new Date(raw);
          var mm = String(dt.getMonth() + 1).padStart(2, '0');
          var dd = String(dt.getDate()).padStart(2, '0');
          return dt.getFullYear() + '-' + mm + '-' + dd;
        }
        return raw ? raw.slice(0, 10) : null;
      } catch(e) { return null; }
    }
  },
  {
    id: 'wilmington',
    name: 'Wilmington, DE',
    note: 'Shooting Victims (Manual)',
    type: 'Victims',
    manual: true,
    dataUrl: 'https://www.wilmingtonde.gov/government/public-safety/wilmington-police-department/compstat-reports',
    count: async function(s, e) {
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  },


  {
    id: 'hampton',
    name: 'Hampton, VA',
    note: 'Gunshot Injuries (Non-Fatal)',
    type: 'Victims',
    dataUrl: 'https://www.hampton.gov/DocumentCenter/View/31010/Gunshot-Injury-Data-?bidId=',
    count: async function(s, e) {
      var auto = await loadAutoData();
      if (auto.hampton && auto.hampton.ok) {
        var windowYear = parseInt(s.slice(0,4));
        var asofYear = auto.hampton.asof ? parseInt(auto.hampton.asof.slice(0,4)) : CURRENT_YEAR;
        return windowYear === asofYear ? auto.hampton.ytd : auto.hampton.prior;
      }
      return null;
    },
    latest: async function() {
      var auto = await loadAutoData();
      if (auto.hampton && auto.hampton.ok && auto.hampton.asof) return auto.hampton.asof;
      return null;
    }
  },
  {
    id: 'omaha',
    name: 'Omaha, NE',
    note: 'Homicides + Non-Fatal Shooting Victims (Gun)',
    type: 'Hom+NFS',
    dataUrl: 'https://police.cityofomaha.org/opd-crime-statistics',
    count: async function(s, e) {
      if (auto.omaha && auto.omaha.ok) {
        var asofYear = auto.omaha.asof ? parseInt(auto.omaha.asof.slice(0,4)) : CURRENT_YEAR;
        return windowYear === asofYear ? auto.omaha.ytd : auto.omaha.prior;
      }
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      if (auto.omaha && auto.omaha.ok && auto.omaha.asof) return auto.omaha.asof;
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  },
  {
    id: 'miamidade',
    name: 'Miami-Dade County, FL',
    note: 'Shooting Victims (Manual)',
    type: 'Victims',
    manual: true,
    dataUrl: 'https://www.miamidade.gov/global/police/crime-stats.page',
    count: async function(s, e) {
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  },
  {
    id: 'buffalo',
    name: 'Buffalo, NY',
    note: 'Shooting Victims (Manual)',
    type: 'Victims',
    manual: true,
    dataUrl: 'https://www.criminaljustice.ny.gov/crimnet/ojsa/tableau_Give_Shooting_Activity.htm',
    count: async function(s, e) {
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  },
  {
    id: 'decatur',
    name: 'Decatur, IL',
    note: 'Shooting Victims (Manual)',
    type: 'Victims',
    manual: true,
    dataUrl: 'https://public.powerdms.com/Dec8366/tree/documents/2060598',
    count: async function(s, e) {
      var key = 'manual_' + this.id + '_' + s.slice(0,4);
      try { var r = await window.storage.get(key); return r ? parseInt(r.value) : null; } catch(e) { return null; }
    },
    latest: async function() {
      try { var r = await window.storage.get('manual_' + this.id + '_asof'); return r ? r.value : null; } catch(e) { return null; }
    }
  }
];

// ─── STATE ────────────────────────────────────────────────────────────────────

var state = {};
var sortField = 'ytd';
var sortDir = -1;

document.getElementById('total-cities').textContent = CITIES.length;

// ─── FETCH ────────────────────────────────────────────────────────────────────

var _manualCityId = null;

function openManual(cityId) {
  _manualCityId = cityId;
  var city = CITIES.find(function(c) { return c.id === cityId; });
  document.getElementById('manualModalTitle').textContent = 'UPDATE ' + city.name.toUpperCase();
  // Pre-fill with existing values
  var s = state[cityId] || {};
  document.getElementById('manualYtd').value   = s.ytd   != null ? s.ytd   : '';
  document.getElementById('manualPrior').value = s.prior != null ? s.prior : '';
  document.getElementById('manualAsof').value  = s.asof  || '';

  document.getElementById('manualModal').classList.add('open');
  document.getElementById('manualYtd').focus();
}

function closeManual() {
  document.getElementById('manualModal').classList.remove('open');
  _manualCityId = null;
}

async function saveManual() {
  if (!_manualCityId) return;
  var year = parseInt(document.getElementById('yearSel').value);
  var ytd   = document.getElementById('manualYtd').value.trim();
  var prior = document.getElementById('manualPrior').value.trim();
  var asof  = document.getElementById('manualAsof').value.trim();
  var id    = _manualCityId;


  try {
    if (ytd)   await window.storage.set('manual_' + id + '_' + year,         ytd);
    if (prior) await window.storage.set('manual_' + id + '_' + (year - 1),   prior);
    if (asof)  await window.storage.set('manual_' + id + '_asof',             asof);

  } catch(e) { console.warn('Storage error', e); }

  // Update state directly without re-fetching
  var priorEnd = asof ? (year - 1) + asof.slice(4) : null;
  state[id] = {
    status: 'ok',
    ytd:   ytd   ? parseInt(ytd)   : null,
    prior: prior ? parseInt(prior) : null,
    asof:  asof  || null,
    priorEnd: priorEnd
  };

  closeManual();
  render();
  updateSummary();
}

// Close modal on overlay click
document.addEventListener('click', function(e) {
  if (e.target.id === 'manualModal') closeManual();
});



async function fetchAll() {
  var year = parseInt(document.getElementById('yearSel').value);
  var w = getWindows(year);

  var btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  btn.textContent = '↻ Fetching...';
  document.getElementById('exportBtn').disabled = true;
  document.getElementById('jpegBtn').disabled = true;

  // Reset NYC PDF cache on each refresh
  var nycCity = CITIES.find(function(c) { return c.id === 'nyc'; });
  if (nycCity) nycCity._parsed = null;
  // Reset St. Louis PDF cache on each refresh
  var stlCity = CITIES.find(function(c) { return c.id === 'stlouis'; });
  if (stlCity) stlCity._parsed = null;

  state = {};
  CITIES.forEach(function(c) { state[c.id] = { status: 'loading' }; });
  render();

  var done = 0;
  setProgress(0.02);

  var promises = CITIES.map(async function(city) {
    // Manual cities: load from storage directly
    if (city.manual) {
      try {
        var mYtd   = await city.count(w.start, w.end);
        var mAsof  = await city.latest();
        // Prior: try auto-fetched data first via city.count, then storage
        var mPrior = await city.count(w.priorStart, w.priorEnd);
        var mPriorEnd = mAsof ? (year - 1) + mAsof.slice(4) : null;
        state[city.id] = { status: 'ok', ytd: mYtd, prior: mPrior, asof: mAsof, priorEnd: mPriorEnd };
      } catch(e) {
        state[city.id] = { status: 'ok', ytd: null, prior: null, asof: null };
      }
      done++;
      setProgress(done / CITIES.length);
      render(); updateSummary();
      document.getElementById('fetchStatus').textContent = done + ' / ' + CITIES.length;
      return;
    }
    try {
      // Fetch YTD count and latest date together
      var step1 = await Promise.all([
        city.count(w.start, w.end),
        city.latest()
      ]);
      var ytd  = step1[0];
      var asof = step1[1];

      // Prior year ends on the same month/day as the latest data, not today
      // e.g. if data runs through 2/19/26, prior window is 1/1/25-2/19/25
      var priorEnd = asof
        ? (year - 1) + asof.slice(4)
        : w.priorEnd;

      var prior = await city.count(w.priorStart, priorEnd);

      state[city.id] = { status: 'ok', ytd: ytd, prior: prior, asof: asof, priorEnd: priorEnd };
    } catch(e) {
      state[city.id] = { status: 'error', err: e.message || String(e) };
    }
    done++;
    setProgress(done / CITIES.length);
    render();
    updateSummary();
    document.getElementById('fetchStatus').textContent = done + ' / ' + CITIES.length;
  });

  await Promise.all(promises);

  setProgress(1);
  setTimeout(function() { setProgress(-1); }, 600);
  btn.disabled = false;
  btn.textContent = '↻ Refresh All';
  document.getElementById('exportBtn').disabled = false;
  document.getElementById('jpegBtn').disabled = false;

  var now = new Date();
  document.getElementById('fetchStatus').textContent =
    'Updated ' + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  document.getElementById('footerTs').textContent =
    'Fetched ' + now.toISOString().slice(0,16).replace('T',' ') +
    ' | YTD: Jan 1\u2013' + w.end + ' | Prior end: per-city as-of date';
}

function setProgress(p) {
  document.getElementById('prog').style.width = (p < 0 ? 0 : p * 100) + '%';
}

// ─── SORT ─────────────────────────────────────────────────────────────────────

function doSort(field) {
  sortDir = (field === sortField) ? sortDir * -1 : -1;
  sortField = field;
  document.querySelectorAll('thead th').forEach(function(th) { th.classList.remove('sorted'); });
  var map = { name: 0, ytd: 1, prior: 2, chg: 3, asof: 4 };
  if (map[field] !== undefined) {
    document.querySelectorAll('thead th')[map[field]].classList.add('sorted');
  }
  render();
}

// ─── RENDER ───────────────────────────────────────────────────────────────────

function render() {
  var tbody = document.getElementById('tbody');

  if (!Object.keys(state).length) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><span class="big">READY</span><p>CLICK REFRESH ALL TO FETCH LIVE DATA</p></td></tr>';
    return;
  }

  var rows = CITIES.map(function(city) {
    var s = state[city.id] || { status: 'pending' };
    var chgVal = (s.status === 'ok' && s.prior > 0) ? (s.ytd - s.prior) / s.prior * 100 : null;
    return { city: city, s: s, chgVal: chgVal };
  });

  rows.sort(function(a, b) {
    if (sortField === 'name') return a.city.name.localeCompare(b.city.name) * sortDir;
    if (sortField === 'type') return (a.city.type || '').localeCompare(b.city.type || '') * sortDir;
    if (sortField === 'asof') return ((a.s.asof || '').localeCompare(b.s.asof || '')) * sortDir;
    var va = sortField === 'ytd' ? (a.s.ytd != null ? a.s.ytd : -Infinity)
           : sortField === 'prior' ? (a.s.prior != null ? a.s.prior : -Infinity)
           : (a.chgVal != null ? a.chgVal : -Infinity);
    var vb = sortField === 'ytd' ? (b.s.ytd != null ? b.s.ytd : -Infinity)
           : sortField === 'prior' ? (b.s.prior != null ? b.s.prior : -Infinity)
           : (b.chgVal != null ? b.chgVal : -Infinity);
    return (va - vb) * sortDir;
  });

  // Check if any manual cities have no data at all
  var anyManualEmpty = rows.some(function(row) {
    return row.city.manual && row.s.status === 'ok' && row.s.ytd == null && row.s.prior == null;
  });

  var firstEmptyManualSeen = false;
  tbody.innerHTML = rows.map(function(row) {
    var city = row.city;
    var s = row.s;
    var chgVal = row.chgVal;

    // Insert divider before first manual city with no data entered, only in default sort order
    var divider = '';
    if (anyManualEmpty && city.manual && !firstEmptyManualSeen &&
        s.status === 'ok' && s.ytd == null && s.prior == null &&
        sortField === 'ytd' && sortDir === -1) {
      firstEmptyManualSeen = true;
      divider = '<tr class="divider-row"><td colspan="6"><span>── MANUAL ENTRY ──────────────────────────</span></td></tr>';
    }

    if (s.status === 'loading') {
      return divider + '<tr><td><div class="city-name"><span class="dot dot-loading"></span>' + city.name + '</div><div class="city-note">' + city.note + '</div></td>' +
        '<td class="num"><span class="sk" style="width:52px"></span></td>' +
        '<td class="num"><span class="sk" style="width:52px"></span></td>' +
        '<td class="chg"><span class="sk" style="width:60px"></span></td>' +
        '<td class="asof"><span class="sk" style="width:72px"></span></td><td></td></tr>';
    }

    if (s.status === 'error') {
      return divider + '<tr><td><div class="city-name"><span class="dot dot-error"></span>' + city.name + '</div><div class="city-note">' + city.note + '</div></td>' +
        '<td colspan="4"><span class="err-msg">' + (s.err || 'Fetch failed') + '</span></td><td class="type-badge"></td></tr>';
    }

    var chgHtml = '<span class="chg-flat">—</span>';
    if (chgVal != null) {
      var sign = chgVal > 0 ? '+' : '';
      var cls  = chgVal > 2 ? 'chg-up' : chgVal < -2 ? 'chg-down' : 'chg-flat';
      var arr  = chgVal > 2 ? '▲ ' : chgVal < -2 ? '▼ ' : '';
      chgHtml  = '<span class="' + cls + '">' + arr + sign + chgVal.toFixed(1) + '%</span>';
    }

    var manualBtn = city.manual ? ' <button class="manual-btn" onclick="openManual(\'' + city.id + '\')" title="Edit">✎ Edit</button>' + (city.dataUrl ? ' <a class="manual-btn" href="' + city.dataUrl + '" target="_blank" title="Open source">↗ Source</a>' : '') : '';
    return divider + '<tr' + (city.manual ? ' class="manual-row"' : '') + '>' +
      '<td><div class="city-name"><span class="dot dot-ok"></span>' + city.name + manualBtn + '</div><div class="city-note">' + city.note + '</div></td>' +
      '<td class="num">' + (s.ytd != null ? s.ytd.toLocaleString() : '—') + '</td>' +
      '<td class="num" style="color:var(--muted2)">' + (s.prior != null ? s.prior.toLocaleString() : '—') + '<div style="font-family:var(--muted);font-size:9px;color:var(--muted);margin-top:2px">thru ' + (s.priorEnd || '') + '</div></td>' +
      '<td class="chg">' + chgHtml + '</td>' +
      '<td class="asof">' + (s.asof || '—') + '</td>' +
      '<td><span class="type-badge type-' + city.type.toLowerCase() + '">' + city.type + '</span></td>' +
      '</tr>';
  }).join('');
}

// ─── SUMMARY ──────────────────────────────────────────────────────────────────

function updateSummary() {
  var ok = Object.values(state).filter(function(s) { return s.status === 'ok' && ((s.ytd != null && s.ytd > 0) || (s.prior != null && s.prior > 0)); });
  var ytdTotal   = ok.reduce(function(n, s) { return n + (s.ytd   || 0); }, 0);
  var priorTotal = ok.reduce(function(n, s) { return n + (s.prior || 0); }, 0);

  document.getElementById('s-cities').textContent = ok.length;
  document.getElementById('s-ytd').textContent    = ytdTotal   ? ytdTotal.toLocaleString()   : '—';
  document.getElementById('s-prior').textContent  = priorTotal ? priorTotal.toLocaleString() : '—';

  if (priorTotal > 0) {
    var pct = (ytdTotal - priorTotal) / priorTotal * 100;
    var el  = document.getElementById('s-chg');
    el.textContent = (pct > 0 ? '+' : '') + pct.toFixed(1) + '%';
    el.style.color = pct > 2 ? 'var(--red)' : pct < -2 ? 'var(--green)' : 'var(--yellow)';
  }
}

// ─── YEAR CHANGE ──────────────────────────────────────────────────────────────

function onYearChange() {
  state = {};
  render();
  ['s-cities','s-ytd','s-prior','s-chg'].forEach(function(id) {
    var el = document.getElementById(id);
    el.textContent = '—';
    el.style.color = '';
  });
  document.getElementById('fetchStatus').textContent = 'Year changed — click Refresh';
  document.getElementById('exportBtn').disabled = true;
  document.getElementById('jpegBtn').disabled = true;
}

// ─── CSV EXPORT ───────────────────────────────────────────────────────────────


function exportJPEG() {
  var year = parseInt(document.getElementById('yearSel').value);
  var now  = new Date().toISOString().slice(0, 10);

  // Gather cities with data only
  var rows = CITIES.map(function(city) {
    var s = state[city.id] || {};
    if (s.ytd == null) return null;
    var chg = (s.prior != null && s.prior > 0) ? ((s.ytd - s.prior) / s.prior * 100) : null;
    return { name: city.name, ytd: s.ytd, prior: s.prior, chg: chg, asof: s.asof };
  }).filter(Boolean);

  if (!rows.length) { alert('No data to export yet — click Refresh All first.'); return; }

  // Sort by ytd descending
  rows.sort(function(a, b) { return b.ytd - a.ytd; });

  // Totals row
  var totalYtd   = rows.reduce(function(s, r) { return s + r.ytd; }, 0);
  var totalPrior = rows.reduce(function(s, r) { return s + (r.prior || 0); }, 0);
  var totalChg   = totalPrior > 0 ? ((totalYtd - totalPrior) / totalPrior * 100) : null;

  // ── Canvas setup ──────────────────────────────────────────────────────────
  var ROW_H   = 36;
  var PAD_TOP = 112;
  var PAD_BOT = 85;
  var W       = 720;
  var H       = PAD_TOP + (rows.length + 1) * ROW_H + PAD_BOT;

  var canvas = document.createElement('canvas');
  canvas.width  = W * 2;  // 2x for retina
  canvas.height = H * 2;
  var ctx = canvas.getContext('2d');
  ctx.scale(2, 2);

  // ── Color palette ─────────────────────────────────────────────────────────
  var FT_SALMON  = '#0D1B2A';   // dark navy background
  var FT_DARK    = '#F5E6C8';   // warm gold primary text
  var FT_MID     = '#B8A88A';   // muted gold secondary text
  var FT_LIGHT   = '#6B5F4E';   // dim gold muted
  var FT_RED     = '#E05555';   // increase = bad (softened red on dark)
  var FT_GREEN   = '#5DBB8A';   // decrease = good (mint green on dark)
  var FT_BORDER  = '#1E3248';   // subtle navy border
  var FT_ACCENT  = '#C9A84C';   // gold accent

  // ── Background ────────────────────────────────────────────────────────────
  ctx.fillStyle = FT_SALMON;
  ctx.fillRect(0, 0, W, H);

  // ── Left accent bar ───────────────────────────────────────────────────────
  ctx.fillStyle = FT_ACCENT;
  ctx.fillRect(0, 0, 5, H);

  // ── Header ────────────────────────────────────────────────────────────────
  ctx.fillStyle = FT_ACCENT;
  ctx.font = 'bold 22px Georgia, serif';
  ctx.fillText('Shooting Victims, ' + year + ' Year-to-Date', 24, 52);

  ctx.fillStyle = FT_MID;
  ctx.font = '12px Georgia, serif';
  ctx.fillText('Selected major US cities · Compared to same period prior year', 24, 74);

  // Horizontal rule under header
  ctx.strokeStyle = FT_BORDER;
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(24, 88); ctx.lineTo(W - 24, 88); ctx.stroke();

  // ── Column headers ────────────────────────────────────────────────────────
  var colCity  = 24;
  var colYTD   = W - 330;
  var colPrior = W - 240;
  var colChg   = W - 140;
  var colAsOf  = W - 24;

  ctx.fillStyle = FT_LIGHT;
  ctx.font = 'bold 10px Arial, sans-serif';
  ctx.textAlign = 'left';  ctx.fillText('CITY', colCity, 103);
  ctx.textAlign = 'right'; ctx.fillText(year + ' YTD', colYTD, 103);
  ctx.textAlign = 'right'; ctx.fillText((year-1) + ' YTD', colPrior, 103);
  ctx.textAlign = 'right'; ctx.fillText('CHANGE', colChg, 103);
  ctx.textAlign = 'right'; ctx.fillText('AS OF', colAsOf, 103);

  // ── Data rows ─────────────────────────────────────────────────────────────
  rows.forEach(function(row, i) {
    var y = PAD_TOP + i * ROW_H + 22;

    // Alternating subtle background
    if (i % 2 === 0) {
      ctx.fillStyle = 'rgba(255,255,255,0.04)';
      ctx.fillRect(0, PAD_TOP + i * ROW_H, W, ROW_H);
    }

    // City name
    ctx.fillStyle = FT_DARK;
    ctx.font = '13px Georgia, serif';
    ctx.textAlign = 'left';
    ctx.fillText(row.name, colCity, y);

    // YTD
    ctx.font = 'bold 13px Georgia, serif';
    ctx.textAlign = 'right';
    ctx.fillText(row.ytd.toLocaleString(), colYTD, y);

    // Prior YTD
    ctx.fillStyle = FT_MID;
    ctx.font = '13px Georgia, serif';
    ctx.fillText(row.prior != null ? row.prior.toLocaleString() : '—', colPrior, y);

    // Change
    if (row.chg != null) {
      var sign = row.chg > 0 ? '+' : '';
      // For shootings, increase = bad (red), decrease = good (green)
      ctx.fillStyle = row.chg > 0 ? FT_RED : FT_GREEN;
      ctx.font = 'bold 13px Georgia, serif';
      ctx.fillText(sign + row.chg.toFixed(1) + '%', colChg, y);
    } else {
      ctx.fillStyle = FT_LIGHT;
      ctx.fillText('—', colChg, y);
    }

    // As Of
    ctx.fillStyle = FT_LIGHT;
    ctx.font = '11px Arial, sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(row.asof || '—', colAsOf, y);

    // Row separator
    ctx.strokeStyle = FT_BORDER;
    ctx.lineWidth = 0.5;
    ctx.beginPath();
    ctx.moveTo(24, PAD_TOP + (i+1) * ROW_H);
    ctx.lineTo(W - 24, PAD_TOP + (i+1) * ROW_H);
    ctx.stroke();
  });

  // ── Total row ─────────────────────────────────────────────────────────────
  var totalY = PAD_TOP + rows.length * ROW_H;

  ctx.fillStyle = FT_ACCENT;
  ctx.fillRect(0, totalY, W, ROW_H);

  var ty = totalY + 23;
  ctx.fillStyle = '#0D1B2A';
  ctx.font = 'bold 13px Georgia, serif';
  ctx.textAlign = 'left';
  ctx.fillText('TOTAL (' + rows.length + ' cities)', colCity, ty);
  ctx.textAlign = 'right';
  ctx.fillText(totalYtd.toLocaleString(), colYTD, ty);
  ctx.fillStyle = 'rgba(13,27,42,0.65)';
  ctx.font = '13px Georgia, serif';
  ctx.fillText(totalPrior.toLocaleString(), colPrior, ty);
  if (totalChg != null) {
    var sign = totalChg > 0 ? '+' : '';
    ctx.fillStyle = totalChg > 0 ? '#8B1A1A' : '#1A4A2E';
    ctx.font = 'bold 13px Georgia, serif';
    ctx.fillText(sign + totalChg.toFixed(1) + '%', colChg, ty);
  }

  // ── Footer ────────────────────────────────────────────────────────────────
  var footY = PAD_TOP + (rows.length + 1) * ROW_H + 20;
  ctx.fillStyle = FT_LIGHT;
  ctx.font = '10px Arial, sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText('Source: Agency Data. Graphic by Jeff Asher.', 24, footY);

  // ── Download ──────────────────────────────────────────────────────────────
  canvas.toBlob(function(blob) {
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'shootings_' + year + '_' + now + '.jpg';
    a.click();
  }, 'image/jpeg', 0.95);
}

function exportCSV() {
  var year = document.getElementById('yearSel').value;
  var w    = getWindows(parseInt(year));
  var now  = new Date().toISOString().slice(0, 10);

  var header = ['City', 'Source', 'Type', 'YTD', 'Last YTD', '% Change', 'As Of', 'YTD End', 'Prior YTD End', 'Export Date'];
  var rows = CITIES.map(function(city) {
    var s = state[city.id] || {};
    var chg = (s.ytd != null && s.prior > 0) ? ((s.ytd - s.prior) / s.prior * 100).toFixed(1) : '';
    return [city.name, city.note, city.type || '', s.ytd != null ? s.ytd : '', s.prior != null ? s.prior : '', chg, s.asof || '', w.end, s.priorEnd || w.priorEnd, now];
  });

  var csv = [header].concat(rows).map(function(r) {
    return r.map(function(v) { return '"' + String(v).replace(/"/g, '""') + '"'; }).join(',');
  }).join('\n');

  var a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
  a.download = 'shootings_' + year + '_' + now + '.csv';
  a.click();
}
</script>
</body>
</html>
