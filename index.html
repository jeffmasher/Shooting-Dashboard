#!/usr/bin/env node

/**
 * Fetch Shooting Data for Multiple Cities
 * Buffalo: Navigate GIVE Dashboard, select Buffalo City PD, extract monthly totals
 * 
 * This script:
 * 1. Fetches automated data via PDF scraping (other cities)
 * 2. Scrapes Buffalo, NY data from NY GIVE Dashboard by:
 *    - Navigating to GIVE-Shooting Activity tab
 *    - Selecting Buffalo City PD jurisdiction
 *    - Summing "Shooting Victims (Persons Hit)" + "Individuals Killed by Gun Violence" monthly totals
 * 3. Updates data/manual-auto.json with YTD comparisons (Jan 2026 vs Jan 2025)
 */

const fs = require('fs');
const path = require('path');
const { chromium } = require('playwright');

// Try to load pdfjs if available
let PDFParser;
try {
  PDFParser = require('pdfjs-dist/legacy/build/pdf');
} catch (e) {
  console.warn('âš ï¸  pdfjs-dist not available - PDF scraping disabled');
}

// Configuration
const DATA_FILE = 'data/manual-auto.json';

const CITIES = {
  detroit: {
    name: 'Detroit, MI',
    pdfUrl: 'https://detroitmi.gov/sites/detroitmi.localhost/files/2025-02/Shooting%20Data%20Report.pdf',
    type: 'pdf'
  },
  durham: {
    name: 'Durham, NC',
    pdfUrl: 'https://www.dconc.gov/sites/default/files/u56/Aggravated%20Assault%20Summary.pdf',
    type: 'pdf'
  },
  milwaukee: {
    name: 'Milwaukee, WI',
    pdfUrl: 'https://city.milwaukee.gov/ImageLibrary/Groups/healthAuthority/MPD/crime-statistics/ShootingReport.pdf',
    type: 'pdf'
  },
  memphis: {
    name: 'Memphis, TN',
    pdfUrl: 'https://www.memphistennessee.org/wp-content/uploads/2022/10/Gunshot-Victims-Report.pdf',
    type: 'pdf'
  },
  pittsburgh: {
    name: 'Pittsburgh, PA',
    pdfUrl: 'https://pittsburghpa.gov/police/community/docs/shootings.pdf',
    type: 'pdf'
  },
  omaha: {
    name: 'Omaha, NE',
    pdfUrl: 'https://www.cityofomaha.org/home/showdocument?id=39847',
    type: 'pdf'
  },
  hampton: {
    name: 'Hampton, VA',
    pdfUrl: 'https://www.hampton.gov/home/showdocument?id=2747',
    type: 'pdf'
  },
  buffalo: {
    name: 'Buffalo, NY',
    dashboardUrl: 'https://mypublicdashboard.ny.gov/t/OJRP_PUBLIC/views/GIVEInitiative/GIVE-LandingPage',
    type: 'tableau'
  },
  miamidade: {
    name: 'Miami-Dade, FL',
    type: 'manual'
  }
};

// â”€â”€â”€ LOAD/SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadData() {
  if (fs.existsSync(DATA_FILE)) {
    try {
      return JSON.parse(fs.readFileSync(DATA_FILE, 'utf8'));
    } catch (e) {
      console.error('Error reading data file:', e.message);
      return {};
    }
  }
  return {};
}

function saveData(data) {
  fs.mkdirSync(path.dirname(DATA_FILE), { recursive: true });
  fs.writeFileSync(DATA_FILE, JSON.stringify(data, null, 2));
  console.log(`âœ“ Saved data to ${DATA_FILE}`);
}

// â”€â”€â”€ BUFFALO GIVE DASHBOARD SCRAPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchBuffaloData(browser) {
  console.log('\nğŸ“Š Fetching Buffalo data from GIVE Dashboard...');
  
  const page = await browser.newPage();
  
  try {
    // Navigate to the GIVE dashboard
    console.log('  Opening dashboard...');
    await page.goto('https://mypublicdashboard.ny.gov/t/OJRP_PUBLIC/views/GIVEInitiative/GIVE-LandingPage', {
      waitUntil: 'domcontentloaded',
      timeout: 45000
    });

    console.log('  Waiting for dashboard to load...');
    await page.waitForTimeout(3000);

    // â”€â”€â”€ NAVIGATE TO SHOOTING ACTIVITY TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    console.log('  Finding GIVE-Shooting Activity tab...');
    
    try {
      // Try to click the Shooting Activity tab by text
      await page.click('text=/Shooting Activity/i', { timeout: 5000 });
      console.log('  âœ“ Clicked Shooting Activity tab');
      await page.waitForTimeout(2000);
    } catch (e) {
      console.log('  âš ï¸  Could not click Shooting Activity tab by text, trying element search...');
      const tabs = await page.locator('[role="tab"]').all();
      let found = false;
      for (let tab of tabs) {
        const text = await tab.textContent();
        if (text && text.toLowerCase().includes('shooting') && text.toLowerCase().includes('activity')) {
          await tab.click();
          console.log('  âœ“ Found and clicked Shooting Activity tab');
          found = true;
          await page.waitForTimeout(2000);
          break;
        }
      }
      if (!found) {
        throw new Error('Could not find Shooting Activity tab');
      }
    }

    // â”€â”€â”€ SELECT BUFFALO CITY PD JURISDICTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    console.log('  Selecting Buffalo City PD jurisdiction...');
    
    let buffaloSelected = false;
    
    // Strategy 1: Try clicking by visible text "Buffalo City PD"
    try {
      await page.click('text=/Buffalo.*City.*PD|Buffalo City Police/i', { timeout: 5000 });
      console.log('  âœ“ Selected Buffalo City PD by text');
      buffaloSelected = true;
      await page.waitForTimeout(2000);
    } catch (e) {
      console.log('  âš ï¸  Direct selection failed, trying dropdown approach...');
      
      // Strategy 2: Find jurisdiction filter/dropdown and interact with it
      try {
        // Look for filter elements
        const filterElements = await page.locator('[class*="filter"], [class*="selector"], [role="combobox"], select').all();
        
        for (let filterEl of filterElements) {
          const text = await filterEl.textContent();
          if (text && (text.includes('Buffalo') || text.includes('Jurisdiction') || text.includes('Agency') || text.includes('Department'))) {
            console.log('  Found potential jurisdiction filter, clicking...');
            await filterEl.click();
            await page.waitForTimeout(1000);
            
            // Now look for Buffalo option
            const options = await page.locator('text=/Buffalo.*City|Buffalo.*PD/i').all();
            if (options.length > 0) {
              await options[0].click();
              console.log('  âœ“ Selected Buffalo City PD from dropdown');
              buffaloSelected = true;
              await page.waitForTimeout(2000);
              break;
            }
          }
        }
      } catch (dropdownErr) {
        console.log('  Dropdown approach failed:', dropdownErr.message);
      }
    }

    if (!buffaloSelected) {
      throw new Error('Could not select Buffalo City PD jurisdiction - data may be from different agency');
    }

    // â”€â”€â”€ VERIFY BUFFALO IS SELECTED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    console.log('  Verifying Buffalo City PD is selected...');
    
    try {
      const pageText = await page.locator('body').textContent();
      if (!pageText || !pageText.toLowerCase().includes('buffalo')) {
        throw new Error('Page does not contain Buffalo data - selection may have failed');
      }
      console.log('  âœ“ Verified Buffalo data is displayed');
    } catch (verifyErr) {
      console.log('  âš ï¸  Verification error:', verifyErr.message, '- proceeding with extraction anyway');
    }

    // â”€â”€â”€ EXTRACT MONTHLY DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    console.log('  Extracting monthly shooting data for Buffalo City PD...');
    
    let monthlyData;
    try {
      monthlyData = await page.evaluate(() => {
        const data = {
          jan2026: { victims: 0, killed: 0 },
          jan2025: { victims: 0, killed: 0 },
          lines: []
        };

        // Get all text from the page
        const allText = document.body.innerText || '';
        const lines = allText.split('\n').map(l => l.trim()).filter(l => l);
        
        data.lines = lines;
        
        // Parse through lines looking for month sections and metrics
        let currentMonth = null;
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          const lower = line.toLowerCase();

          // Detect month markers
          if (lower.match(/january\s+2026|jan\s+2026|january\s*2026/)) {
            currentMonth = 'jan2026';
          } else if (lower.match(/january\s+2025|jan\s+2025|january\s*2025/)) {
            currentMonth = 'jan2025';
          }

          // Extract numbers following metric keywords
          if (lower.includes('shooting victims') || lower.includes('persons hit')) {
            // Look in next 2 lines for a number
            for (let j = i + 1; j <= i + 2 && j < lines.length; j++) {
              const numMatch = lines[j].match(/(\d+)/);
              if (numMatch && currentMonth) {
                const num = parseInt(numMatch[1]);
                if (num > 0) {
                  data[currentMonth].victims = num;
                  break;
                }
              }
            }
          }

          if (lower.includes('killed') || lower.includes('individuals killed by gun violence')) {
            // Look in next 2 lines for a number
            for (let j = i + 1; j <= i + 2 && j < lines.length; j++) {
              const numMatch = lines[j].match(/(\d+)/);
              if (numMatch && currentMonth) {
                const num = parseInt(numMatch[1]);
                if (num > 0) {
                  data[currentMonth].killed = num;
                  break;
                }
              }
            }
          }
        }

        return data;
      });
    } catch (extractErr) {
      console.log('  âš ï¸  Error during evaluation:', extractErr.message);
      monthlyData = {
        jan2026: { victims: 0, killed: 0 },
        jan2025: { victims: 0, killed: 0 },
        lines: []
      };
    }

    console.log('  Extracted monthly data:');
    console.log(`    January 2026 - Victims: ${monthlyData.jan2026.victims}, Killed: ${monthlyData.jan2026.killed}`);
    console.log(`    January 2025 - Victims: ${monthlyData.jan2025.victims}, Killed: ${monthlyData.jan2025.killed}`);

    // Save debug HTML if extraction had issues
    if ((monthlyData.jan2026.victims === 0 && monthlyData.jan2026.killed === 0) || 
        (monthlyData.jan2025.victims === 0 && monthlyData.jan2025.killed === 0)) {
      try {
        const pageHtml = await page.content();
        fs.writeFileSync('buffalo-debug.html', pageHtml);
        console.log('  â„¹ï¸  Saved page HTML to buffalo-debug.html for debugging');
        // Log sample lines
        const sampleLines = monthlyData.lines.filter(l => /\d/.test(l)).slice(0, 20);
        console.log('  Sample lines with numbers:', sampleLines.join(' | '));
      } catch (debugErr) {
        console.log('  Could not save debug info:', debugErr.message);
      }
    }

    // Calculate YTD totals
    const ytd2026 = monthlyData.jan2026.victims + monthlyData.jan2026.killed;
    const ytd2025 = monthlyData.jan2025.victims + monthlyData.jan2025.killed;

    console.log(`  YTD 2026 (Jan): ${ytd2026}`);
    console.log(`  YTD 2025 (Jan): ${ytd2025}`);

    if (ytd2026 > 0 || ytd2025 > 0) {
      return {
        ytd: ytd2026,
        prior: ytd2025,
        asof: new Date().toISOString().split('T')[0],
        jan2026Victims: monthlyData.jan2026.victims,
        jan2026Killed: monthlyData.jan2026.killed,
        jan2025Victims: monthlyData.jan2025.victims,
        jan2025Killed: monthlyData.jan2025.killed,
        jurisdiction: 'Buffalo City PD',
        success: true
      };
    } else {
      console.log('  âš ï¸  Could not extract numbers from dashboard');
      // Log some sample lines for debugging
      const sampleLines = monthlyData.lines.filter(l => /\d/.test(l)).slice(0, 10);
      console.log('  Sample lines with numbers:', sampleLines);
      return null;
    }

  } catch (err) {
    console.error('  âœ— Error scraping Buffalo dashboard:', err.message);
    return null;
  } finally {
    await page.close();
  }
}

// â”€â”€â”€ PDF SCRAPER (existing functionality) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchPdfData(pdfUrl, cityId) {
  if (!PDFParser) {
    console.log(`  âŠ˜ ${cityId}: pdfjs-dist not installed, skipping PDF scraping`);
    return null;
  }

  console.log(`  Fetching ${cityId}...`);
  
  try {
    const response = await fetch(pdfUrl);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const buffer = await response.arrayBuffer();
    const pdf = await PDFParser.getDocument({ data: buffer }).promise;
    
    let allText = '';
    const numPages = Math.min(pdf.numPages, 3);
    
    for (let i = 1; i <= numPages; i++) {
      const page = await pdf.getPage(i);
      const textContent = await page.getTextContent();
      allText += textContent.items.map(item => item.str).join(' ') + '\n';
    }

    const ytdMatch = allText.match(/YTD\s*:?\s*(\d+)/i) || 
                      allText.match(/year.*to.*date.*(\d+)/i) ||
                      allText.match(/2026\s*(\d+)/i);
    const priorMatch = allText.match(/prior\s*:?\s*(\d+)/i) ||
                       allText.match(/2025\s*(\d+)/i);

    if (ytdMatch) {
      return {
        ytd: parseInt(ytdMatch[1]),
        prior: priorMatch ? parseInt(priorMatch[1]) : null,
        asof: new Date().toISOString().split('T')[0],
        success: true
      };
    }
    
    console.log(`  âš ï¸  Could not parse data for ${cityId}`);
    return null;

  } catch (err) {
    console.error(`  âœ— ${cityId} error: ${err.message}`);
    return null;
  }
}

// â”€â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function main() {
  console.log('ğŸ”„ Fetching shooting data...\n');
  
  const data = loadData();
  const browser = await chromium.launch({ headless: true });
  
  try {
    // â”€â”€â”€ BUFFALO (GIVE Dashboard) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const buffaloResult = await fetchBuffaloData(browser);
    
    if (buffaloResult && buffaloResult.success) {
      data.buffalo = {
        ytd: buffaloResult.ytd,
        prior: buffaloResult.prior,
        asof: buffaloResult.asof,
        jurisdiction: buffaloResult.jurisdiction || 'Buffalo City PD',
        fetchedAt: new Date().toISOString(),
        ok: true
      };
      console.log('âœ“ Buffalo updated\n');
    } else {
      if (!data.buffalo) {
        data.buffalo = {
          ytd: null,
          prior: null,
          asof: null,
          fetchedAt: new Date().toISOString(),
          ok: false
        };
      } else {
        data.buffalo.fetchedAt = new Date().toISOString();
      }
      console.log('âœ— Buffalo fetch failed, preserved existing data\n');
    }

    // â”€â”€â”€ PDF CITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    console.log('ğŸ“„ Fetching PDF data...');
    const pdfCities = ['detroit', 'durham', 'milwaukee', 'memphis', 'pittsburgh', 'omaha', 'hampton'];
    
    for (const cityId of pdfCities) {
      const config = CITIES[cityId];
      if (config && config.type === 'pdf') {
        const result = await fetchPdfData(config.pdfUrl, cityId);
        if (result) {
          data[cityId] = {
            ...result,
            fetchedAt: new Date().toISOString(),
            ok: true
          };
          console.log(`âœ“ ${cityId} updated`);
        } else {
          if (!data[cityId]) {
            data[cityId] = {
              ytd: null,
              prior: null,
              asof: null,
              fetchedAt: new Date().toISOString(),
              ok: false
            };
          }
        }
      }
    }

    // â”€â”€â”€ MIAMI-DADE (Manual/External) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (!data.miamidade) {
      data.miamidade = {
        ytd: null,
        prior: null,
        asof: null,
        fetchedAt: new Date().toISOString(),
        ok: false
      };
    }

    saveData(data);
    console.log('\nâœ… Fetch complete');

  } catch (err) {
    console.error('\nâŒ Fatal error:', err.message);
    process.exit(1);
  } finally {
    await browser.close();
  }
}

main();
